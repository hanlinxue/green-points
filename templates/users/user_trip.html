<!-- 用户出行记录中心 -->
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <title>提交出行 - GreenPoints</title>
      <link rel="stylesheet" href="../../static/css/style.css">
  <style>
    .panel input, .panel select, .panel textarea {
      width: 100%;
      padding: 8px 10px;
      margin-top: 6px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    .panel button {
      margin-top: 12px;
    }
    .scroll-container {
      max-height: 300px;
      overflow-y: auto;
    }
    .trip-item {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
    }
    .trip-item:last-child {
      border-bottom: none;
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      background-color: #52e6b0;
      color: #fff;
      font-size: 0.8rem;
    }
  </style>
</head>
<body onload="initUserTripProfile()">

  <div class="dashboard">

    <nav class="dash-nav">
      <div class="brand">GreenPoints 商城</div>
      <a href="{{ url_for('user.user_index') }}">全部商品</a>
      <a href="{{ url_for('user.user_profile') }}">个人中心</a>
      <a class="active" href="#">提交出行</a>
      <a href="{{ url_for('user.user_out') }}">退出登录</a>
    </nav>

    <section class="dash-main">

      <!-- 顶部信息栏 -->
      <div class="dash-header">
        <div>
          <h1>提交出行记录</h1>
          <p>记录您的绿色出行行为，积分实时到账。</p>
        </div>
        <button class="btn" onclick="submitTrip()">提交记录</button>
      </div>

      <!-- 出行记录表单 -->
      <div class="panel hover-lift">
        <div class="panel-header">
          <h2>出行信息</h2>
          <span class="pill">必填</span>
        </div>

        <div class="form-row">
          <label>出行周期</label>
          <input id="trip_period" placeholder="如：2025-11-01 ~ 2025-11-07">
        </div>

        <div class="form-row">
          <label>出行方式</label>
          <select id="trip_mode">
            <option value="walk">步行</option>
            <option value="bike">自行车</option>
            <option value="public_transit">公共交通</option>
            <option value="car">汽车</option>
          </select>
        </div>

        <div class="form-row">
          <label>里程（公里）</label>
          <input id="trip_distance" type="number" step="0.1" placeholder="请输入里程">
        </div>

        <div class="form-row">
          <label>备注（可选）</label>
          <textarea id="trip_note" placeholder="路线、出行目的等"></textarea>
        </div>
      </div>

      <!-- 出行记录列表 -->
      <div class="panel hover-lift">
        <div class="panel-header">
          <h2>历史出行记录</h2>
        </div>
        <div id="tripHistory" class="scroll-container">
          <!-- 由 JS 填充 -->
        </div>
      </div>

    </section>

  </div>

  <script>
    function initUserTripProfile() {
      fetchUserTrips();
    }

    function fetchUserTrips() {
      fetch("/user_trip")
        .then(res => res.json())
        .then(data => {
          const list = document.getElementById("tripHistory");
          list.innerHTML = "";
          if (!data || data.length === 0) {
            list.innerHTML = `<p style="padding:12px;color:#999;">暂无出行记录</p>`;
            return;
          }
          data.forEach(trip => {
            const div = document.createElement("div");
            div.className = "trip-item";
            div.innerHTML = `
              <div><strong>周期：</strong>${trip.period}</div>
              <div><strong>方式：</strong>${trip.mode}</div>
              <div><strong>里程：</strong>${trip.distance} 公里</div>
              <div><strong>备注：</strong>${trip.note || '—'}</div>
              <div><span class="pill">${trip.status === 'approved' ? '已审核' : '待审核'}</span></div>
            `;
            list.appendChild(div);
          });
        })
        .catch(err => {
          console.error(err);
          alert("加载出行记录失败");
        });
    }

    function submitTrip() {
      const period = document.getElementById("trip_period").value.trim();
      const mode = document.getElementById("trip_mode").value;
      const distance = parseFloat(document.getElementById("trip_distance").value);
      const note = document.getElementById("trip_note").value.trim();

      if (!period || !mode || isNaN(distance)) return alert("请填写完整信息");

      fetch("/api/user/trips", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({period, mode, distance, note})
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("提交成功，等待审核");
          fetchUserTrips();
        } else {
          alert("提交失败：" + (data.message || "未知错误"));
        }
      })
      .catch(err => {
        console.error(err);
        alert("提交出行记录失败");
      });
    }
  </script>

</body>
</html>
