<!-- 用户浏览商品并用积分兑换 -->
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <title>积分商城 - 绿色出行</title>
  <link rel="stylesheet" href="../../static/css/style.css">
  <link rel="stylesheet" href="../../static/css/products.css">
  <link rel="stylesheet" href="../../static/css/common.css">
  <style>
    /* 收货地址选择样式 */
    .address-selector {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid #e9ecef;
    }

    .address-selector label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.75rem;
    }

    .address-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .address-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .address-item:hover {
      background-color: #f8f9fa;
      border-color: #007bff;
    }

    .address-item.selected {
      background-color: #e3f2fd;
      border-color: #007bff;
    }

    .address-info {
      flex: 1;
    }

    .address-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }

    .address-name {
      font-weight: 500;
    }

    .address-phone {
      color: #6c757d;
      font-size: 0.875rem;
    }

    .address-default {
      background-color: #28a745;
      color: white;
      font-size: 0.75rem;
      padding: 0.125rem 0.375rem;
      border-radius: 4px;
    }

    .address-detail {
      color: #495057;
      font-size: 0.875rem;
    }

    .address-radio {
      margin-left: 0.5rem;
    }

    .address-empty {
      text-align: center;
      padding: 1.5rem;
      color: #6c757d;
    }

    .address-empty a {
      color: #007bff;
      text-decoration: none;
    }

    .address-empty a:hover {
      text-decoration: underline;
    }

    .address-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem;
      color: #6c757d;
    }

    .spinner-small {
      width: 16px;
      height: 16px;
      border: 2px solid #e9ecef;
      border-top-color: #007bff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .btn-small {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
      background-color: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    .btn-small:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body onload="initProductsPage()">
  <div class="dashboard">
    <nav class="dash-nav">
      <div class="brand">绿色出行商城</div>
      <a href="#" class="active">全部商品</a>
      <div class="nav-item">
        <span>当前积分: <strong id="currentPoints">0</strong></span>
      </div>
      <a href="{{ url_for('user.user_trip') }}">提交出行</a>
      <a href="{{ url_for('user.user_profile') }}">个人中心</a>
      <a href="{{ url_for('user.user_out') }}">退出登录</a>
    </nav>

    <section class="dash-main">
      <div class="dash-header">
        <div>
          <h1>积分兑换商城</h1>
          <p>精选绿色合作商户，积分扣减后生成订单并同步通知商户。</p>
        </div>
        <div class="header-actions">
          <select id="categoryFilter" class="form-select" onchange="filterProducts()">
            <option value="">所有分类</option>
            <option value="日用品">日用品</option>
            <option value="文创">文创</option>
            <option value="数码">数码</option>
          </select>
          <button class="btn-outline" onclick="fetchProducts()">
            <i class="bi bi-arrow-clockwise"></i> 刷新列表
          </button>
        </div>
      </div>

      <div class="panel hover-lift">
        <div class="panel-header">
          <h2>绿色精选商品</h2>
          <span class="pill">积分实时扣减</span>
        </div>

        <!-- 加载提示 -->
        <div id="loadingSpinner" class="text-center py-5">
          <div class="spinner"></div>
          <p>正在加载商品...</p>
        </div>

        <!-- 商品列表 -->
        <div id="productList" class="product-grid" style="display: none;"></div>

        <!-- 空状态提示 -->
        <div id="emptyState" class="text-center py-5" style="display: none;">
          <i class="bi bi-box-seam" style="font-size: 3rem; color: #999;"></i>
          <h3 class="mt-3">暂无商品</h3>
          <p>目前没有可兑换的商品，请稍后再试</p>
        </div>
      </div>
    </section>
  </div>

  <!-- 兑换确认模态框 -->
  <div id="exchangeModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>确认兑换</h3>
        <span class="close" onclick="closeExchangeModal()">&times;</span>
      </div>
      <div class="modal-body">
        <p>您确定要兑换以下商品吗？</p>
        <div id="selectedProductInfo" class="product-info">
          <!-- 商品信息将动态填充 -->
        </div>
        <div class="quantity-selector">
          <label for="exchangeQuantity">兑换数量：</label>
          <div class="quantity-controls">
            <button type="button" id="decreaseQty" class="btn-quantity">-</button>
            <input type="number" id="exchangeQuantity" value="1" min="1" max="1" readonly>
            <button type="button" id="increaseQty" class="btn-quantity">+</button>
          </div>
          <span class="max-quantity">（库存：<span id="stockQuantity">0</span>）</span>
        </div>

        <!-- 收货地址选择 -->
        <div class="address-selector">
          <label for="addressSelect">收货地址：</label>
          <div class="address-loading" id="addressLoading" style="display: none;">
            <div class="spinner-small"></div>
            <span>加载地址中...</span>
          </div>
          <div id="addressList" class="address-list" style="display: none;">
            <!-- 地址列表将动态填充 -->
          </div>
          <div id="addressEmpty" class="address-empty" style="display: none;">
            <p>暂无收货地址</p>
            <a href="{{ url_for('user.user_address') }}" class="btn-small">添加地址</a>
          </div>
        </div>

        <div class="alert-warning">
          <i class="bi bi-exclamation-triangle"></i>
          兑换将消耗 <strong id="exchangePoints">0</strong> 积分
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeExchangeModal()">取消</button>
        <button class="btn-primary" id="confirmExchangeBtn">确认兑换</button>
      </div>
    </div>
  </div>

  <!-- 提示信息 -->
  <div id="toast" class="toast" style="display: none;"></div>

  <script src="../../static/js/script.js"></script>
  <script>
    let products = [];
    let userPoints = 0;
    let userAddresses = [];
    let selectedAddressId = null;

    // 页面初始化
    async function initProductsPage() {
      await fetchUserPoints();
      await fetchUserAddresses();
      await fetchProducts();
    }

    // 获取用户积分
    async function fetchUserPoints() {
      try {
        const response = await fetch('/user/user_profile/user_points');
        if (response.ok) {
          const data = await response.json();
          userPoints = data.points || 0;
          document.getElementById('currentPoints').textContent = userPoints;
        }
      } catch (error) {
        console.error('获取积分失败:', error);
      }
    }

    // 获取用户收货地址
    async function fetchUserAddresses() {
      try {
        const response = await fetch('/user/user_profile/user_address');
        if (response.ok) {
          userAddresses = await response.json();

          // 默认选择第一个地址或默认地址
          if (userAddresses.length > 0) {
            const defaultAddress = userAddresses.find(addr => addr.is_default) || userAddresses[0];
            selectedAddressId = defaultAddress.id;
          }
        }
      } catch (error) {
        console.error('获取收货地址失败:', error);
      }
    }

    // 获取商品列表
    async function fetchProducts() {
      const loadingSpinner = document.getElementById('loadingSpinner');
      const productList = document.getElementById('productList');
      const emptyState = document.getElementById('emptyState');

      // 显示加载提示
      loadingSpinner.style.display = 'block';
      productList.style.display = 'none';
      emptyState.style.display = 'none';

      try {
        const response = await fetch('/user/products');
        if (response.ok) {
          products = await response.json();
          loadingSpinner.style.display = 'none';

          if (products.length > 0) {
            displayProducts(products);
            productList.style.display = 'grid';
          } else {
            emptyState.style.display = 'block';
          }
        } else {
          throw new Error('获取商品列表失败');
        }
      } catch (error) {
        console.error('获取商品失败:', error);
        loadingSpinner.style.display = 'none';
        showToast('获取商品列表失败，请稍后重试', 'error');
        emptyState.style.display = 'block';
      }
    }

    // 显示商品列表
    function displayProducts(productsToDisplay) {
      const productList = document.getElementById('productList');
      productList.innerHTML = '';

      productsToDisplay.forEach(product => {
        const productCard = document.createElement('div');
        productCard.className = 'product-card';
        productCard.innerHTML = `
          <div class="product-image">
            <img src="${product.img_url || '/static/img/default_product.png'}"
                 alt="${product.goods_name}"
                 onerror="this.src='/static/img/default_product.png'">
            ${product.stock <= 0 ? '<span class="sold-out-badge">售罄</span>' : ''}
          </div>
          <div class="product-info">
            <h3 class="product-name">${product.goods_name}</h3>
            <p class="product-category">${product.category}</p>
            <p class="product-desc">${product.description}</p>
            <div class="product-footer">
              <div class="product-points">
                <i class="bi bi-gift-fill"></i>
                <span>${product.need_points} 积分</span>
              </div>
              <div class="product-stock">
                库存: ${product.stock}
              </div>
            </div>
            <button class="btn-exchange"
                    onclick="showExchangeModal(${product.id})"
                    ${product.stock <= 0 || userPoints < product.need_points ? 'disabled' : ''}>
              ${product.stock <= 0 ? '已售罄' :
                userPoints < product.need_points ? '积分不足' : '立即兑换'}
            </button>
          </div>
        `;
        productList.appendChild(productCard);
      });
    }

    // 筛选商品
    function filterProducts() {
      const category = document.getElementById('categoryFilter').value;
      let filteredProducts = products;

      if (category) {
        filteredProducts = products.filter(p => p.category === category);
      }

      displayProducts(filteredProducts);
    }

    // 显示兑换确认模态框
    function showExchangeModal(productId) {
      const product = products.find(p => p.id === productId);
      if (!product) return;

      const modal = document.getElementById('exchangeModal');
      const productInfo = document.getElementById('selectedProductInfo');
      const exchangePoints = document.getElementById('exchangePoints');
      const exchangeQuantity = document.getElementById('exchangeQuantity');
      const stockQuantity = document.getElementById('stockQuantity');
      const decreaseBtn = document.getElementById('decreaseQty');
      const increaseBtn = document.getElementById('increaseQty');

      // 设置商品信息
      productInfo.innerHTML = `
        <div class="modal-product">
          <img src="${product.img_url || '/static/img/default_product.png'}"
               alt="${product.goods_name}">
          <div class="modal-product-details">
            <h4>${product.goods_name}</h4>
            <p class="text-muted">${product.description}</p>
            <p>分类: ${product.category}</p>
            <p>库存: ${product.stock}</p>
          </div>
        </div>
      `;

      // 设置库存和初始数量
      stockQuantity.textContent = product.stock;
      exchangeQuantity.value = 1;
      exchangeQuantity.max = product.stock;

      // 计算并显示总积分
      updateTotalPoints(product.need_points, 1);

      // 显示收货地址
      displayAddressList();

      // 绑定数量增减按钮事件
      decreaseBtn.onclick = () => {
        let currentQty = parseInt(exchangeQuantity.value);
        if (currentQty > 1) {
          currentQty--;
          exchangeQuantity.value = currentQty;
          updateTotalPoints(product.need_points, currentQty);
          updateQuantityButtons(currentQty, product.stock, product.need_points);
        }
      };

      increaseBtn.onclick = () => {
        let currentQty = parseInt(exchangeQuantity.value);
        const maxQty = Math.min(product.stock, Math.floor(userPoints / product.need_points));
        if (currentQty < maxQty) {
          currentQty++;
          exchangeQuantity.value = currentQty;
          updateTotalPoints(product.need_points, currentQty);
          updateQuantityButtons(currentQty, product.stock, product.need_points);
        }
      };

      // 初始化按钮状态
      updateQuantityButtons(1, product.stock, product.need_points);

      // 绑定确认按钮事件
      document.getElementById('confirmExchangeBtn').onclick = () => exchangeProduct(productId);

      modal.style.display = 'block';
    }

    // 更新总积分显示
    function updateTotalPoints(pointsPerItem, quantity) {
      const totalPoints = pointsPerItem * quantity;
      document.getElementById('exchangePoints').textContent = totalPoints;
    }

    // 更新数量按钮状态
    function updateQuantityButtons(currentQty, stock, pointsPerItem) {
      const decreaseBtn = document.getElementById('decreaseQty');
      const increaseBtn = document.getElementById('increaseQty');
      const exchangeQuantity = document.getElementById('exchangeQuantity');

      const maxQty = Math.min(stock, Math.floor(userPoints / pointsPerItem));

      // 更新按钮状态
      decreaseBtn.disabled = currentQty <= 1;
      increaseBtn.disabled = currentQty >= maxQty || currentQty >= stock;
    }

    // 显示收货地址列表
    function displayAddressList() {
      const addressLoading = document.getElementById('addressLoading');
      const addressList = document.getElementById('addressList');
      const addressEmpty = document.getElementById('addressEmpty');

      // 隐藏所有状态
      addressLoading.style.display = 'none';
      addressList.style.display = 'none';
      addressEmpty.style.display = 'none';

      if (userAddresses.length === 0) {
        addressEmpty.style.display = 'block';
      } else {
        addressList.style.display = 'block';
        addressList.innerHTML = userAddresses.map(addr => `
          <div class="address-item ${selectedAddressId === addr.id ? 'selected' : ''}"
               onclick="selectAddress(${addr.id})"
               data-address-id="${addr.id}">
            <div class="address-info">
              <div class="address-header">
                <span class="address-name">${addr.name}</span>
                <span class="address-phone">${addr.phone}</span>
                ${addr.is_default ? '<span class="address-default">默认</span>' : ''}
              </div>
              <div class="address-detail">${addr.region} ${addr.detail}</div>
            </div>
            <div class="address-radio">
              <input type="radio" name="address" value="${addr.id}"
                     ${selectedAddressId === addr.id ? 'checked' : ''}>
            </div>
          </div>
        `).join('');
      }
    }

    // 选择收货地址
    function selectAddress(addressId) {
      selectedAddressId = addressId;

      // 更新选中状态
      document.querySelectorAll('.address-item').forEach(item => {
        if (parseInt(item.dataset.addressId) === addressId) {
          item.classList.add('selected');
          item.querySelector('input[type="radio"]').checked = true;
        } else {
          item.classList.remove('selected');
          item.querySelector('input[type="radio"]').checked = false;
        }
      });
    }

    // 关闭兑换模态框
    function closeExchangeModal() {
      document.getElementById('exchangeModal').style.display = 'none';
    }

    // 兑换商品
    async function exchangeProduct(productId) {
      const product = products.find(p => p.id === productId);
      if (!product) return;

      const exchangeQuantity = parseInt(document.getElementById('exchangeQuantity').value);
      const totalPointsNeeded = product.need_points * exchangeQuantity;

      // 验证数量
      if (exchangeQuantity < 1) {
        showToast('请选择正确的兑换数量', 'error');
        return;
      }

      if (exchangeQuantity > product.stock) {
        showToast('兑换数量超过库存数量', 'error');
        return;
      }

      if (userPoints < totalPointsNeeded) {
        showToast('积分不足，无法兑换', 'error');
        return;
      }

      if (product.stock <= 0) {
        showToast('商品库存不足', 'error');
        return;
      }

      // 验证收货地址
      if (!selectedAddressId) {
        showToast('请选择收货地址', 'error');
        return;
      }

      try {
        // 获取选中的地址信息
        const selectedAddress = userAddresses.find(addr => addr.id === selectedAddressId);
        if (!selectedAddress) {
          showToast('收货地址信息错误', 'error');
          return;
        }

        // 构造地址字符串
        const addressString = `${selectedAddress.name} / ${selectedAddress.phone} / ${selectedAddress.region} ${selectedAddress.detail}`;

        // 调用我们创建的兑换接口
        const response = await fetch('/user/api/orders', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            productId: productId,
            address: addressString,
            quantity: exchangeQuantity
          })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          showToast(result.message, 'success');
          closeExchangeModal();

          // 刷新用户积分和商品列表
          await fetchUserPoints();
          await fetchProducts();
        } else {
          showToast(result.message || '兑换失败', 'error');
        }
      } catch (error) {
        console.error('兑换失败:', error);
        showToast('兑换失败，请稍后重试', 'error');
      }
    }

    // 显示提示信息
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      toast.style.display = 'block';

      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }

    // 点击模态框外部关闭
    window.onclick = function(event) {
      const modal = document.getElementById('exchangeModal');
      if (event.target === modal) {
        closeExchangeModal();
      }
    }
  </script>

<script src="/static/js/welcome_bar_enhanced.js"></script>
</body>
</html>
