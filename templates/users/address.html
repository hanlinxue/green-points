<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>收货地址管理 - GreenPoints</title>
  <link rel="stylesheet" href="../../static/css/style.css" />
  <!-- 新增按钮美化样式（直接嵌入，也可移到style.css） -->
  <style>
    /* 基础按钮样式：统一圆角、间距、动画 */
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px; /* 核心：圆角美化 */
      color: white;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease; /* hover 丝滑动画 */
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* 轻微阴影增加层次感 */
    }

    /* 新增收货地址按钮（主绿色） */
    .btn-add {
      background-color: #4CAF50;
    }
    .btn-add:hover {
      background-color: #45a049;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }

    /* 编辑/设为默认按钮（浅绿） */
    .btn-edit {
      background-color: #81C784;
    }
    .btn-edit:hover {
      background-color: #66BB6A;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }

    /* 删除按钮（浅红） */
    .btn-delete {
      background-color: #E57373;
    }
    .btn-delete:hover {
      background-color: #EF5350;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }

    /* 保存按钮（深绿） */
    .btn-save {
      background-color: #2E7D32;
    }
    .btn-save:hover {
      background-color: #27662B;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }

    /* 取消按钮（浅灰） */
    .btn-cancel {
      background-color: #BDBDBD;
      color: #333; /* 灰色文字更协调 */
    }
    .btn-cancel:hover {
      background-color: #9E9E9E;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }

    /* 地址项按钮容器：调整间距 */
    .address-btn-group {
      display: flex;
      gap: 10px; /* 按钮之间间距 */
      margin-top: 8px;
    }
  </style>
</head>

<body onload="initAddressPage()">

  <div class="dashboard">

    <nav class="dash-nav">
        <a href="/user/user_profile" class="back-arrow" style="
            margin-right: 15px;
            color: white;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            font-weight: 500;
        ">
        <span style="margin-right: 4px;">←返回</span>
        </a>
        <div class="brand">GreenPoints 商城</div>
        <a href="{{ url_for('user.user_index') }}">全部商品</a>
        <a class="active" href="#">收货地址</a>
        <a href="{{ url_for('user.user_trip') }}">提交出行</a>
        <a href="{{ url_for('user.user_out') }}">退出登录</a>
    </nav>

    <section class="dash-main">

      <!-- 顶部：修改「新增收货地址」按钮class -->
      <div class="dash-header">
        <div>
          <h1>收货地址管理</h1>
          <p>管理你的收货地址用于商城订单配送</p>
        </div>
        <button class="btn btn-add" onclick="showAddAddress()">新增收货地址</button>
      </div>

      <div class="panel hover-lift">
        <div class="panel-header">
          <h2>已有收货地址</h2>
        </div>
        <div id="addressList" class="scroll-container"></div>
      </div>

      <!-- 新增/编辑表单：修改保存/取消按钮class -->
      <div id="addressFormPanel" class="panel hover-lift" style="display:none; margin-top:20px;">
        <div class="panel-header">
          <h2 id="formTitle">新增收货地址</h2>
        </div>
        <div class="form-row">
          <label>收货人姓名</label>
          <input id="addrName" type="text" class="input">
        </div>
        <div class="form-row">
          <label>手机号码</label>
          <input id="addrPhone" type="text" class="input">
        </div>
        <div class="form-row">
          <label>所在地区</label>
          <input id="addrRegion" type="text" class="input" placeholder="如：湖北省 襄阳市 樊城区">
        </div>
        <div class="form-row">
          <label>详细地址</label>
          <input id="addrDetail" type="text" class="input">
        </div>
        <div class="form-row">
          <label>设为默认地址</label>
          <input id="addrDefault" type="checkbox">
        </div>
        <div style="display: flex; gap: 20px; margin-top: 15px;">
            <button class="btn btn-save" onclick="saveAddress()">保存地址</button>
            <button class="btn btn-cancel" onclick="hideForm()">取消</button>
        </div>
      </div>

    </section>
  </div>

  <script src="../../static/js/script.js"></script>
  <script>
    let editingId = null;

    // 页面加载
    function initAddressPage() {
      loadAddressList();
    }

    // 请求地址列表
    function loadAddressList() {
      fetch("/user/user_profile/user_address")
        .then(res => res.json())
        .then(data => renderAddressList(data));
    }

    // 渲染地址列表：修改按钮class + 增加容器优化间距
    function renderAddressList(list) {
      const box = document.getElementById("addressList");
      box.innerHTML = "";

      // 空列表提示
      if (list.length === 0) {
        box.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">暂无收货地址，点击「新增收货地址」添加</div>';
        return;
      }

      list.forEach(addr => {
        let item = document.createElement("div");
        item.className = "address-item";
        // 关键修改：按钮添加新class + 用address-btn-group容器控制间距
        item.innerHTML = `
          <div style="margin-bottom: 8px;">
            <strong>${addr.name}</strong> ${addr.phone} <br>
            ${addr.region} ${addr.detail}
            ${addr.is_default ? '<span class="pill green">默认</span>' : ""}
          </div>
          <div class="address-btn-group">
            <button class="btn btn-edit" onclick="editAddress(${addr.id})">编辑</button>
            <button class="btn btn-delete" onclick="deleteAddress(${addr.id})">删除</button>
            ${!addr.is_default ? `<button class="btn btn-edit" onclick="setDefault(${addr.id})">设为默认</button>` : ""}
          </div>
        `;
        box.appendChild(item);
      });
    }

    // 显示新增地址表单
    function showAddAddress() {
      editingId = null;
      document.getElementById("formTitle").innerText = "新增收货地址";
      clearForm();
      document.getElementById("addressFormPanel").style.display = "block";
    }

    // 清除表单字段
    function clearForm() {
      document.getElementById("addrName").value = "";
      document.getElementById("addrPhone").value = "";
      document.getElementById("addrRegion").value = "";
      document.getElementById("addrDetail").value = "";
      document.getElementById("addrDefault").checked = false;
    }

    // 编辑地址
    function editAddress(id) {
      editingId = id;
      fetch(`/user/user_profile/user_address/get/${id}`)
        .then(res => res.json())
        .then(addr => {
          document.getElementById("formTitle").innerText = "编辑地址";
          document.getElementById("addrName").value = addr.name;
          document.getElementById("addrPhone").value = addr.phone;
          document.getElementById("addrRegion").value = addr.region;
          document.getElementById("addrDetail").value = addr.detail;
          document.getElementById("addrDefault").checked = addr.is_default;
          document.getElementById("addressFormPanel").style.display = "block";
        })
        .catch(err => { // 新增异常捕获
          console.error("编辑地址失败：", err);
          alert("加载地址详情失败，请稍后重试！");
        });
    }

    // 删除地址
    function deleteAddress(id) {
      if (!confirm("确定要删除这个地址吗？")) return;
      fetch(`/user/user_profile/user_address/delete/${id}`, { method: "POST" })
        .then(() => loadAddressList())
        .catch(err => { // 新增异常捕获
          console.error("删除地址失败：", err);
          alert("删除地址失败，请稍后重试！");
        });
    }

    // 设置为默认地址
    function setDefault(id) {
      fetch(`/user/user_profile/user_address/set_default/${id}`, { method: "POST" })
        .then(() => loadAddressList())
        .catch(err => { // 新增异常捕获
          console.error("设为默认地址失败：", err);
          alert("设为默认地址失败，请稍后重试！");
        });
    }

    // 保存地址（新增或更新）
    function saveAddress() {
      // 1. 获取并清洗表单数据
      const addrName = document.getElementById("addrName").value.trim();
      const addrPhone = document.getElementById("addrPhone").value.trim();
      const addrRegion = document.getElementById("addrRegion").value.trim();
      const addrDetail = document.getElementById("addrDetail").value.trim();
      const isDefault = document.getElementById("addrDefault").checked;

      // 2. 前端基础校验
      if (!addrName) {
        alert("收货人姓名不能为空！");
        return;
      }
      if (!addrPhone) {
        alert("手机号码不能为空！");
        return;
      }
      if (!addrRegion) {
        alert("所在地区不能为空！");
        return;
      }
      if (!addrDetail) {
        alert("详细地址不能为空！");
        return;
      }
      // 仅校验11位数字
      const phoneReg = /^\d{11}$/;
      if (!phoneReg.test(addrPhone)) {
          alert("请输入有效的11位手机号码！");
          return;
      }

      // 3. 构造请求体
      const body = {
        name: addrName,
        phone: addrPhone,
        region: addrRegion,
        detail: addrDetail,
        is_default: isDefault
      };

      // 4. 区分新建/更新接口路径
      const url = editingId
        ? `/user/user_profile/user_address/update/${editingId}`
        : `/user/user_profile/user_address/add`;

      // 5. 发送POST请求
      fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      })
      .then(res => {
        if (!res.ok) {
          return res.json().then(errData => {
            throw new Error(errData.error || `操作失败：${res.status}`);
          });
        }
        return res.json();
      })
      .then(data => {
        alert(editingId ? "地址更新成功！" : "地址新增成功！");
        hideForm();
        loadAddressList();
      })
      .catch(err => {
        console.error("保存地址失败：", err);
        alert(err.message || "保存地址失败，请稍后重试！");
      });
    }

    function hideForm() {
      document.getElementById("addressFormPanel").style.display = "none";
    }
  </script>

</body>
</html>