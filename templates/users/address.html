<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>收货地址管理 - GreenPoints</title>
  <link rel="stylesheet" href="../../static/css/style.css" />
</head>

<body onload="initAddressPage()">

  <div class="dashboard">

    <nav class="dash-nav">
      <div class="brand">GreenPoints 商城</div>
      <a href="{{ url_for('user.user_index') }}">全部商品</a>
     <a class="active" href="#">收获地址</a>
    <a href="{{ url_for('user.user_trip') }}">提交出行</a>
      <a href="{{ url_for('user.user_out') }}">退出登录</a>
    </nav>

    <section class="dash-main">

      <!-- 顶部 -->
      <div class="dash-header">
        <div>
          <h1>收货地址管理</h1>
          <p>管理你的收货地址用于商城订单配送</p>
        </div>
        <button class="btn" onclick="showAddAddress()">新增收货地址</button>
      </div>


      <!-- 地址列表 -->
      <div class="panel hover-lift">
        <div class="panel-header">
          <h2>已有收货地址</h2>
        </div>

        <div id="addressList" class="scroll-container">
          <!-- JS 渲染 -->
        </div>
      </div>


      <!-- 新增 / 编辑地址的表单 -->
      <div id="addressFormPanel" class="panel hover-lift" style="display:none; margin-top:20px;">
        <div class="panel-header">
          <h2 id="formTitle">新增收货地址</h2>
        </div>

        <div class="form-row">
          <label>收货人姓名</label>
          <input id="addrName" type="text" class="input">
        </div>

        <div class="form-row">
          <label>手机号码</label>
          <input id="addrPhone" type="text" class="input">
        </div>

        <div class="form-row">
          <label>所在地区</label>
          <input id="addrRegion" type="text" class="input" placeholder="如：浙江省 杭州市 西湖区">
        </div>

        <div class="form-row">
          <label>详细地址</label>
          <input id="addrDetail" type="text" class="input">
        </div>

        <div class="form-row">
          <label>设为默认地址</label>
          <input id="addrDefault" type="checkbox">
        </div>

        <button class="btn" onclick="saveAddress()">保存地址</button>
        <button class="btn gray" onclick="hideForm()">取消</button>
      </div>

    </section>
  </div>


  <script src="../../static/js/script.js"></script>
  <script>
    let editingId = null;

    // 页面加载
    function initAddressPage() {
      loadAddressList();
    }

    // 请求地址列表
    function loadAddressList() {
      fetch("/api/user/address/list")
        .then(res => res.json())
        .then(data => renderAddressList(data));
    }

    // 渲染地址列表
    function renderAddressList(list) {
      const box = document.getElementById("addressList");
      box.innerHTML = "";

      list.forEach(addr => {
        let item = document.createElement("div");
        item.className = "address-item";

        item.innerHTML = `
          <div>
            <strong>${addr.name}</strong> ${addr.phone} <br>
            ${addr.region} ${addr.detail}
            ${addr.is_default ? '<span class="pill green">默认</span>' : ""}
          </div>

          <div>
            <button class="btn small" onclick="editAddress(${addr.id})">编辑</button>
            <button class="btn small red" onclick="deleteAddress(${addr.id})">删除</button>
            ${!addr.is_default ? `<button class="btn small" onclick="setDefault(${addr.id})">设为默认</button>` : ""}
          </div>
        `;

        box.appendChild(item);
      });
    }

    // 显示新增地址表单
    function showAddAddress() {
      editingId = null;
      document.getElementById("formTitle").innerText = "新增收货地址";
      clearForm();
      document.getElementById("addressFormPanel").style.display = "block";
    }

    // 清除表单字段
    function clearForm() {
      document.getElementById("addrName").value = "";
      document.getElementById("addrPhone").value = "";
      document.getElementById("addrRegion").value = "";
      document.getElementById("addrDetail").value = "";
      document.getElementById("addrDefault").checked = false;
    }

    // 编辑地址
    function editAddress(id) {
      editingId = id;
      fetch(`/api/user/address/${id}`)
        .then(res => res.json())
        .then(addr => {
          document.getElementById("formTitle").innerText = "编辑地址";
          document.getElementById("addrName").value = addr.name;
          document.getElementById("addrPhone").value = addr.phone;
          document.getElementById("addrRegion").value = addr.region;
          document.getElementById("addrDetail").value = addr.detail;
          document.getElementById("addrDefault").checked = addr.is_default;

          document.getElementById("addressFormPanel").style.display = "block";
        });
    }

    // 删除地址
    function deleteAddress(id) {
      if (!confirm("确定要删除这个地址吗？")) return;

      fetch(`/api/user/address/delete/${id}`, { method: "POST" })
        .then(() => loadAddressList());
    }

    // 设置为默认地址
    function setDefault(id) {
      fetch(`/api/user/address/set_default/${id}`, { method: "POST" })
        .then(() => loadAddressList());
    }

    // 保存地址（新增或更新）
    function saveAddress() {
      const body = {
        name: document.getElementById("addrName").value,
        phone: document.getElementById("addrPhone").value,
        region: document.getElementById("addrRegion").value,
        detail: document.getElementById("addrDetail").value,
        is_default: document.getElementById("addrDefault").checked
      };

      const url = editingId
        ? `/api/user/address/update/${editingId}`
        : `/api/user/address/add`;

      fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      })
      .then(() => {
        hideForm();
        loadAddressList();
      });
    }

    function hideForm() {
      document.getElementById("addressFormPanel").style.display = "none";
    }
  </script>

</body>
</html>
