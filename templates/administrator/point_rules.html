<!-- 积分兑换规则（拆分出行方式+单独参考值） -->
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <title>积分兑换规则 - 管理后台</title>
  <link rel="stylesheet" href="../../static/css/style.css">
  <style>
    /* 补充样式 */
    .nice-table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
    }
    .nice-table th, .nice-table td {
      padding: 12px 16px;
      border: 1px solid #eee;
      text-align: left;
    }
    .nice-table th {
      background-color: #f8f9fa;
      font-weight: 600;
    }
    .btn {
      padding: 8px 16px;
      background-color: #52e6b0;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn:hover {
      background-color: #40d39c;
    }
    .btn-outline {
      padding: 8px 16px;
      background-color: transparent;
      color: #52e6b0;
      border: 1px solid #52e6b0;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-outline:hover {
      background-color: #f0fff9;
    }
    .btn-danger {
      padding: 6px 12px;
      background-color: #ff4d4f;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .btn-danger:hover {
      background-color: #ff7875;
    }
    .input-number {
      width: 120px;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    /* 新增备注输入框样式 */
    .input-remark {
      width: 200px;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: none;
      height: 32px;
      line-height: 1.4;
    }
    .select-mode {
      width: 140px;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .tip-text {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 8px;
      line-height: 1.8;
    }
    .reference-box {
      background-color: #f8f9fa;
      padding: 12px 16px;
      border-radius: 4px;
      margin: 8px 0 16px;
      border-left: 3px solid #52e6b0;
    }
    .reference-item {
      margin: 4px 0;
    }
  </style>
</head>
<body onload="initPointRules()">

  <div class="dashboard">
    <nav class="dash-nav">
      <div class="brand">绿色出行管理平台</div>
      <a href="{{ url_for('admin.admin_index') }}">审核中心</a>
      <a href="{{ url_for("admin.admin_users") }}">账户管理</a>
      <a class="active" href="#">积分兑换规则</a>
      <a href="{{ url_for("user.index") }}">退出登录</a>
    </nav>

    <div class="dash-main">
      <div class="dash-header">
        <div>
          <h1>积分兑换规则</h1>
          <p>用于计算用户出行可获得的积分（积分 = 里程 × 碳减排系数 × 积分兑换系数）。</p>
        </div>
        <button class="btn" onclick="savePointRules()">保存所有修改</button>
      </div>

      <div class="panel hover-lift">
        <div class="panel-header">
          <h2>出行方式积分规则</h2>
          <span class="pill">碳减排系数(kg CO₂/公里) | 积分兑换系数(积分/kg) | 规则备注</span>
        </div>

        <!-- 拆分后的参考值展示 -->
        <div class="reference-box">
          <div class="reference-item" style="font-size: 12px;"><strong>碳减排系数参考值：</strong></div>
          <div class="reference-item" style="font-size: 12px;">• 步行：0.2 kg CO₂/公里</div>
          <div class="reference-item" style="font-size: 12px;">• 跑步：0.2 kg CO₂/公里</div>
          <div class="reference-item" style="font-size: 12px;">• 自行车：0.2 kg CO₂/公里</div>
          <div class="reference-item" style="font-size: 12px;">• 公交车：0.18 kg CO₂/公里</div>
          <div class="reference-item" style="font-size: 12px;">• 地铁：0.197 kg CO₂/公里</div>
          <div class="reference-item" style="font-size: 12px;">• 私家车(电动)：0.15 kg CO₂/公里</div>
          <div class="reference-item" style="margin-top:8px; font-size: 12px;"><strong>积分兑换系数参考值：</strong>10 积分/kg CO₂</div>
        </div>

        <table class="nice-table">
          <thead>
            <tr>
              <th>出行方式</th>
              <th>碳减排系数（kg CO₂/公里）</th>
              <th>积分兑换系数（积分/kg）</th>
              <!-- 新增：规则备注列头 -->
              <th>规则备注</th>
              <th style="width:100px;">操作</th>
            </tr>
          </thead>
          <tbody id="ruleTable">
            <!-- JS 自动填充 -->
          </tbody>
        </table>

        <button class="btn-outline" onclick="addPointRule()" style="margin-top:16px;">新增规则</button>
      </div>

      <!-- 积分兑换货币汇率 -->
      <div class="panel hover-lift" style="margin-top: 24px;">
        <div class="panel-header">
          <h2>积分兑换货币汇率</h2>
          <span class="pill">1积分 = X现实货币</span>
        </div>

        <div class="reference-box">
          <div class="reference-item" style="font-size: 12px;"><strong>汇率说明：</strong></div>
          <div class="reference-item" style="font-size: 12px;">• 汇率表示1积分可以兑换多少现实货币</div>
          <div class="reference-item" style="font-size: 12px;">• 汇率设置后将影响积分提现功能</div>
          <div class="reference-item" style="font-size: 12px;">• 建议根据当前市场情况合理设置汇率</div>
        </div>

        <table class="nice-table">
          <thead>
            <tr>
              <th>货币代码</th>
              <th>货币名称</th>
              <th>货币符号</th>
              <th>兑换汇率（1积分=）</th>
              <th>状态</th>
              <th style="width:100px;">操作</th>
            </tr>
          </thead>
          <tbody id="exchangeRateTable">
            <!-- JS 自动填充 -->
          </tbody>
        </table>

        <button class="btn-outline" onclick="addExchangeRate()" style="margin-top:16px;">新增汇率</button>
        <button class="btn" onclick="saveExchangeRates()" style="margin-top:16px; margin-left:8px;">保存汇率</button>
      </div>
    </div>
  </div>

  <script>
    // 拆分后的出行方式映射（新增跑步/地铁，拆分公交车）
    const tripModeOptions = [
      { value: "walk", text: "步行" },
      { value: "run", text: "跑步" },
      { value: "bike", text: "自行车" },
      { value: "bus", text: "公交车" },
      { value: "subway", text: "地铁" },
      { value: "car", text: "私家车(电动)" }
    ];

    // 页面加载初始化
    function initPointRules() {
      // 加载出行方式规则
      fetch("/admin/rules_show")
        .then(res => {
          if (!res.ok) throw new Error("接口请求失败");
          return res.json();
        })
        .then(data => {
          if (!data.success) {
            alert(data.message);
            return;
          }
          renderRuleTable(data.data);
        })
        .catch(err => {
          console.error("加载规则失败：", err);
          alert("加载积分规则失败，请刷新重试！");
        });

      // 加载积分兑换汇率
      fetchExchangeRates();
    }

    // 加载积分兑换汇率
    function fetchExchangeRates() {
      fetch("/admin/exchange_rates_show")
        .then(res => {
          if (!res.ok) throw new Error("接口请求失败");
          return res.json();
        })
        .then(data => {
          if (!data.success) {
            alert(data.message);
            return;
          }
          renderExchangeRateTable(data.data);
        })
        .catch(err => {
          console.error("加载汇率失败：", err);
          alert("加载积分兑换汇率失败，请刷新重试！");
        });
    }

    // 渲染兑换汇率表格
    function renderExchangeRateTable(rateList) {
      const tableBody = document.getElementById("exchangeRateTable");
      tableBody.innerHTML = "";

      rateList.forEach(rate => {
        const tr = document.createElement("tr");
        tr.dataset.currencyCode = rate.currency_code;
        tr.dataset.rateId = rate.id;
        tr.innerHTML = `
          <td>
            <input type="text" class="input-currency-code" value="${rate.currency_code || ''}"
                   placeholder="如：CNY" style="width: 80px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px;">
          </td>
          <td>
            <input type="text" class="input-currency-name" value="${rate.currency_name || ''}"
                   placeholder="如：人民币" style="width: 100px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px;">
          </td>
          <td>
            <input type="text" class="input-currency-symbol" value="${rate.symbol || ''}"
                   placeholder="如：¥" style="width: 50px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px;">
          </td>
          <td>
            <input type="number" class="input-number exchange-rate"
                   step="0.0001" min="0" value="${rate.exchange_rate || 0}"
                   placeholder="0.0000" style="width: 120px;">
          </td>
          <td>
            <select class="select-active" style="width: 80px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px;">
              <option value="true" ${rate.is_active ? 'selected' : ''}>启用</option>
              <option value="false" ${!rate.is_active ? 'selected' : ''}>禁用</option>
            </select>
          </td>
          <td>
            <button class="btn-danger" onclick="deleteExchangeRateRow(this)">删除</button>
          </td>
        `;
        tableBody.appendChild(tr);
      });
    }

    // 新增兑换汇率行
    function addExchangeRate() {
      const tableBody = document.getElementById("exchangeRateTable");
      const emptyRows = tableBody.querySelectorAll("tr:not([data-currency-code])");
      // 已有空行则不重复新增
      if (emptyRows.length > 0) return;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <input type="text" class="input-currency-code" placeholder="如：CNY"
                 style="width: 80px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px;">
        </td>
        <td>
          <input type="text" class="input-currency-name" placeholder="如：人民币"
                 style="width: 100px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px;">
        </td>
        <td>
          <input type="text" class="input-currency-symbol" placeholder="如：¥"
                 style="width: 50px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px;">
        </td>
        <td>
          <input type="number" class="input-number exchange-rate"
                 step="0.0001" min="0" value="0" placeholder="0.0000" style="width: 120px;">
        </td>
        <td>
          <select class="select-active" style="width: 80px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px;">
            <option value="true">启用</option>
            <option value="false">禁用</option>
          </select>
        </td>
        <td>
          <button class="btn-danger" onclick="deleteExchangeRateRow(this)">删除</button>
        </td>
      `;
      tableBody.appendChild(tr);
    }

    // 删除兑换汇率行
    function deleteExchangeRateRow(btn) {
      if (!confirm("确定要删除这条汇率吗？")) return;
      const tr = btn.closest("tr");
      const rateId = tr.dataset.rateId;
      const currencyCode = tr.dataset.currencyCode;

      // 如果是已存在的汇率，需要调用后端删除
      if (rateId) {
        fetch(`/admin/exchange_rates_delete/${rateId}`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json"
          }
        })
        .then(res => {
          if (!res.ok) throw new Error("删除失败");
          return res.json();
        })
        .then(data => {
          alert(data.message);
          if (data.success) {
            tr.remove();
          }
        })
        .catch(err => {
          console.error("删除汇率失败：", err);
          alert("删除积分兑换汇率失败，请重试！");
        });
      } else {
        // 如果是新增的行，直接删除
        tr.remove();
      }
    }

    // 保存兑换汇率
    function saveExchangeRates() {
      const rateRows = document.querySelectorAll("#exchangeRateTable tr");
      const rateData = [];
      const currencyCodeSet = new Set();

      try {
        for (let tr of rateRows) {
          const currencyCode = tr.querySelector(".input-currency-code").value.trim();
          const currencyName = tr.querySelector(".input-currency-name").value.trim();
          const symbol = tr.querySelector(".input-currency-symbol").value.trim();
          const exchangeRate = parseFloat(tr.querySelector(".exchange-rate").value || 0);
          const isActive = tr.querySelector(".select-active").value === 'true';

          // 校验必填字段
          if (!currencyCode) {
            throw new Error("货币代码不能为空！");
          }
          if (!currencyName) {
            throw new Error("货币名称不能为空！");
          }
          if (!symbol) {
            throw new Error("货币符号不能为空！");
          }
          if (isNaN(exchangeRate) || exchangeRate < 0) {
            throw new Error("兑换汇率必须是非负数！");
          }

          // 校验重复货币代码
          if (currencyCodeSet.has(currencyCode)) {
            throw new Error(`发现重复的货币代码：${currencyCode}，请删除重复行！`);
          }
          currencyCodeSet.add(currencyCode);

          rateData.push({
            currency_code: currencyCode,
            currency_name: currencyName,
            symbol: symbol,
            exchange_rate: exchangeRate,
            is_active: isActive
          });
        }

        // 校验空列表
        if (rateData.length === 0) {
          throw new Error("暂无汇率数据可保存，请先新增汇率！");
        }

        // 提交数据
        fetch("/admin/save_exchange_rates", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(rateData)
        })
        .then(res => {
          if (!res.ok) throw new Error("网络请求失败，请检查接口是否正常");
          return res.json();
        })
        .then(data => {
          alert(data.message);
          if (data.success) {
            fetchExchangeRates();
          }
        })
        .catch(err => {
          console.error("保存汇率失败：", err);
          alert(`保存积分兑换汇率失败：${err.message}`);
        });

      } catch (err) {
        alert(err.message);
      }
    }

    // 渲染规则表格（新增备注字段处理）
function renderRuleTable(ruleList) {
  const tableBody = document.getElementById("ruleTable");
  tableBody.innerHTML = "";

  ruleList.forEach(rule => {
    const tr = document.createElement("tr");
    tr.dataset.mode = rule.trip_mode;
    tr.dataset.ruleId = rule.id; // 新增：存储规则ID，用于删除
    tr.innerHTML = `
      <td>
        <select class="select-mode" disabled>
          ${tripModeOptions.map(opt =>
            `<option value="${opt.value}" ${opt.value === rule.trip_mode ? "selected" : ""}>${opt.text}</option>`
          ).join("")}
        </select>
      </td>
      <td>
        <input type="number" class="input-number carbon-coeff"
               step="0.01" min="0" value="${rule.carbon_reduction_coeff || 0}">
      </td>
      <td>
        <input type="number" class="input-number point-coeff"
               step="0.1" min="0" value="${rule.point_exchange_coeff || 0}">
      </td>
      <td>
        <textarea class="input-remark" placeholder="填写规则备注（如：步行每公里减排0.2kg CO₂）">${rule.remark || ""}</textarea>
      </td>
      <td>
        <button class="btn-danger" onclick="deleteRuleRow(this)">删除</button>
      </td>
    `;
    tableBody.appendChild(tr);
  });
}
    // 新增规则行（新增备注输入框）
    function addPointRule() {
  const tableBody = document.getElementById("ruleTable");
  const emptyRows = document.querySelectorAll("#ruleTable tr:not([data-mode])");
  // 1. 已有空行则不重复新增
  if (emptyRows.length > 0) return;

  // 2. 新增：校验已存在的出行方式，避免重复新增
  const existingModes = [];
  document.querySelectorAll("#ruleTable tr[data-mode]").forEach(tr => {
    existingModes.push(tr.dataset.mode);
  });

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>
      <select class="select-mode">
        ${tripModeOptions.map(opt =>
          // 对已存在的出行方式，新增时置灰不可选
          `<option value="${opt.value}" ${existingModes.includes(opt.value) ? "disabled" : ""}>${opt.text}</option>`
        ).join("")}
      </select>
    </td>
    <td>
      <input type="number" class="input-number carbon-coeff" step="0.01" min="0" value="0">
    </td>
    <td>
      <input type="number" class="input-number point-coeff" step="0.1" min="0" value="0">
    </td>
    <td>
      <textarea class="input-remark" placeholder="填写规则备注（如：步行每公里减排0.2kg CO₂）"></textarea>
    </td>
    <td>
      <button class="btn-danger" onclick="deleteRuleRow(this)">删除</button>
    </td>
  `;
  tableBody.appendChild(tr);
}

    // 删除规则行
    function deleteRuleRow(btn) {
  if (!confirm("确定要删除这条规则吗？")) return;
  const tr = btn.closest("tr");
  const ruleId = tr.dataset.ruleId; // 获取规则ID
  const tripMode = tr.dataset.mode; // 备用：如果没有ID，可用trip_mode

  // 新增：调用后端删除接口
  fetch(`/admin/rules_delete/${ruleId}`, {
    method: "DELETE",
    headers: {
      "Content-Type": "application/json"
    }
  })
  .then(res => {
    if (!res.ok) throw new Error("删除失败");
    return res.json();
  })
  .then(data => {
    alert(data.message);
    if (data.success) {
      tr.remove(); // 接口删除成功后，再删除页面DOM行
    }
  })
  .catch(err => {
    console.error("删除规则失败：", err);
    alert("删除积分规则失败，请重试！");
  });
}

    // 保存规则（新增备注字段收集与提交）
 function savePointRules() {
  const ruleRows = document.querySelectorAll("#ruleTable tr");
  const ruleData = [];
  // 用于校验重复出行方式
  const tripModeSet = new Set();
  // 获取保存按钮并禁用，防止重复提交
  const saveBtn = document.querySelector('.dash-header .btn');
  saveBtn.disabled = true;
  saveBtn.textContent = "保存中...";

  try {
    for (let tr of ruleRows) {
      const modeSelect = tr.querySelector(".select-mode");
      const carbonInput = tr.querySelector(".carbon-coeff");
      const pointInput = tr.querySelector(".point-coeff");
      const remarkInput = tr.querySelector(".input-remark");

      const tripMode = modeSelect.value;
      // 优化：保留两位小数，处理浮点数精度问题
      const carbonCoeff = parseFloat((carbonInput.value || 0).trim()).toFixed(2);
      const pointCoeff = parseFloat((pointInput.value || 0).trim()).toFixed(1);
      const remark = remarkInput.value.trim();

      // 1. 校验出行方式非空
      if (!tripMode) {
        throw new Error("请选择出行方式！");
      }
      // 2. 校验重复出行方式
      if (tripModeSet.has(tripMode)) {
        throw new Error(`发现重复的出行方式：${modeSelect.options[modeSelect.selectedIndex].text}，请删除重复行！`);
      }
      tripModeSet.add(tripMode);
      // 3. 校验碳减排系数合法性
      if (isNaN(carbonCoeff) || Number(carbonCoeff) < 0) {
        carbonInput.focus();
        throw new Error("碳减排系数必须是非负数！");
      }
      // 4. 校验积分兑换系数合法性
      if (isNaN(pointCoeff) || Number(pointCoeff) < 0) {
        pointInput.focus();
        throw new Error("积分兑换系数必须是非负数！");
      }

      ruleData.push({
        trip_mode: tripMode,
        carbon_reduction_coeff: Number(carbonCoeff), // 转回数字类型
        point_exchange_coeff: Number(pointCoeff),
        remark: remark
      });
    }

    // 校验空列表
    if (ruleData.length === 0) {
      throw new Error("暂无规则数据可保存，请先新增规则！");
    }

    // 提交数据
    fetch("/admin/save_rules", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(ruleData)
    })
    .then(res => {
      if (!res.ok) throw new Error("网络请求失败，请检查接口是否正常");
      return res.json();
    })
    .then(data => {
      alert(data.message);
      if (data.success) {
        initPointRules();
      }
    })
    .catch(err => {
      console.error("保存规则失败：", err);
      alert(`保存积分规则失败：${err.message}`);
    })
    .finally(() => {
      // 恢复按钮状态
      saveBtn.disabled = false;
      saveBtn.textContent = "保存所有修改";
    });

  } catch (err) {
    alert(err.message);
    // 恢复按钮状态
    saveBtn.disabled = false;
    saveBtn.textContent = "保存所有修改";
  }
}
  </script>
</body>
</html>