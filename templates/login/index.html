<!-- 登录页面 -->
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <title>登录 - GreenPoints</title>
  <link rel="stylesheet" href="../../static/css/style.css">
  <style>
    /* 轻量级补充样式（不会影响你原设计） */
    .tab-switch {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #e5e5e5;
    }
    .tab-btn {
      flex: 1;
      text-align: center;
      padding: 10px;
      cursor: pointer;
      font-weight: 600;
      color: #5b6375;
    }
    .tab-btn.active {
      color: #1d2a41;
      border-bottom: 3px solid #1d2a41;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fade .25s; }

    @keyframes fade { from {opacity:0;} to {opacity:1;} }

    .code-btn {
      margin-left: 10px;
      padding: 8px 12px;
      border: none;
      background:#1d2a41;
      color:white;
      border-radius: 6px;
      cursor: pointer;
      font-size:14px;
    }
  </style>
</head>
<body>
  <div class="eco-shell">
    <aside class="eco-illustration">
      <div class="illustration-content">
        <h1>绿行积分</h1>
        <p>加入“晋碳行”，记录低碳出行，随时获取积分并兑换绿色福利。</p>
        <div class="badge-row">
          <span class="badge-soft">出行积分</span>
          <span class="badge-soft">实时审核</span>
          <span class="badge-soft">积分商城</span>
        </div>
        <div class="wave-animation"></div>
      </div>
    </aside>

    <section class="eco-form">

      <div class="form-header">
        <h2>用户登录</h2>
        <p>支持用户、商户、管理员账号，凭证一致即可登录。</p>
      </div>

      <!-- 登录方式切换按钮 -->
      <div class="tab-switch">
        <div class="tab-btn active" onclick="switchTab('pwd')">账号密码登录</div>
        <div class="tab-btn" onclick="switchTab('sms')">手机验证码登录</div>
      </div>

      <!-- ========== 账号密码登录========== -->
      <div id="tab_pwd" class="tab-content active">
        <form onsubmit="login(); return false;">
          <div class="input-group">
            <input id="login_id" class="input" placeholder="账号 / 用户ID" autocomplete="username">
            <input id="login_password" class="input" placeholder="密码" type="password" autocomplete="current-password">
          </div>

          <div class="form-actions">
            <label style="font-weight:600;color:#1d2a41">
              <input id="rememberMe" type="checkbox" style="margin-right:8px;">记住我
            </label>
            <a href="{{ url_for("user.forgot") }}" class="link" style="font-size:14px;">忘记密码？</a>
          </div>

          <button type="submit" class="btn">立即登录</button>
        </form>
      </div>

      <!-- ========== 手机验证码登录========== -->
      <div id="tab_sms" class="tab-content">
        <div class="input-group">
          <!-- 角色选择 -->
          <div style="margin-bottom: 15px;">
            <label style="font-weight: 600; color: #1d2a41; margin-bottom: 8px; display: block;">选择登录角色</label>
            <div style="display: flex; gap: 15px;">
              <label style="cursor: pointer;">
                <input type="radio" name="login_role" value="user" checked style="margin-right: 5px;">
                用户
              </label>
              <label style="cursor: pointer;">
                <input type="radio" name="login_role" value="merchant" style="margin-right: 5px;">
                商户
              </label>
              <label style="cursor: pointer;">
                <input type="radio" name="login_role" value="admin" style="margin-right: 5px;">
                系统管理员
              </label>
            </div>
          </div>

          <input id="phone" class="input" placeholder="手机号" maxlength="11">

          <div style="display:flex;align-items:center;margin-top:12px;">
            <input id="sms_code" class="input" placeholder="短信验证码" style="flex:1;">
            <button class="code-btn" onclick="sendSmsCode(this)">获取验证码</button>
          </div>
        </div>

        <button class="btn" onclick="loginBySMS()">手机号登录</button>
      </div>

      <p style="text-align:center;margin-top:18px;font-size:14px;color:#5b6375;">
        还没有账号？<a href="{{ url_for("user.register") }}" class="link">立即注册</a>
      </p>
    </section>
  </div>

  <script src="../../static/js/script.js"></script>
  <script>
    initLoginPage();

    function switchTab(type) {
      document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(area => area.classList.remove("active"));

      if (type === "pwd") {
        document.querySelectorAll(".tab-btn")[0].classList.add("active");
        document.getElementById("tab_pwd").classList.add("active");
      } else {
        document.querySelectorAll(".tab-btn")[1].classList.add("active");
        document.getElementById("tab_sms").classList.add("active");
      }
    }

  // 发送短信验证码函数
  async function sendSmsCode(btn) {
    let phone = document.getElementById("phone").value;
    let selectedRole = document.querySelector('input[name="login_role"]:checked').value;

    if (!/^1[3-9][0-9]{9}$/.test(phone)) {
      alert("请输入正确的手机号！");
      return;
    }

    try {
      const response = await fetch("/user/send_sms_code", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ phone, role: selectedRole })
      });

      const result = await response.json();

      if (response.ok && result.success) {
        alert(`验证码已发送！${result.debug_code ? `（测试验证码：${result.debug_code}）` : ''}`);

        // 开始倒计时（60秒）
        let countdown = 60;
        btn.disabled = true;
        btn.textContent = `${countdown}秒后重试`;

        const timer = setInterval(() => {
          countdown--;
          if (countdown <= 0) {
            clearInterval(timer);
            btn.disabled = false;
            btn.textContent = "获取验证码";
          } else {
            btn.textContent = `${countdown}秒后重试`;
          }
        }, 1000);
      } else {
        alert(result.message || "验证码发送失败");
      }
    } catch (error) {
      console.error("发送验证码失败：", error);
      alert("验证码发送失败，请稍后重试");
    }
  }

// 短信登录函数
  async function loginBySMS() {
    let phone = document.getElementById("phone").value;
    let code = document.getElementById("sms_code").value;
    let selectedRole = document.querySelector('input[name="login_role"]:checked').value;

    if (!phone || !code) {
      alert("请输入手机号和验证码！");
      return;
    }

    try {
      const response = await fetch("/user/login_sms", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ phone, code, role: selectedRole })
      });

      const result = await response.json();

      if (response.ok && result.message) {
        alert(result.message);

        // 根据用户角色跳转到不同页面
        if (result.role === "user") {
          window.location.href = "/user/user_index";
        } else if (result.role === "merchant") {
          window.location.href = "/merchant/merchant_product";
        } else if (result.role === "admin") {
          window.location.href = "/admin/admin_index";
        }
      } else {
        alert(result.message || "登录失败");
      }
    } catch (error) {
      console.error("短信登录失败：", error);
      alert("登录失败，请稍后重试");
    }
  }
  </script>
</body>
</html>
