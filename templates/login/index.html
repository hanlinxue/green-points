<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <title>登录 - GreenPoints</title>
  <link rel="stylesheet" href="../../static/css/style.css">
  <style>
    /* 轻量级补充样式（不会影响你原设计） */
    .tab-switch {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #e5e5e5;
    }
    .tab-btn {
      flex: 1;
      text-align: center;
      padding: 10px;
      cursor: pointer;
      font-weight: 600;
      color: #5b6375;
    }
    .tab-btn.active {
      color: #1d2a41;
      border-bottom: 3px solid #1d2a41;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fade .25s; }

    @keyframes fade { from {opacity:0;} to {opacity:1;} }

    .code-btn {
      margin-left: 10px;
      padding: 8px 12px;
      border: none;
      background:#1d2a41;
      color:white;
      border-radius: 6px;
      cursor: pointer;
      font-size:14px;
      transition: all 0.3s;
    }
    .code-btn.disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    
    /* 添加输入验证样式 */
    .input.invalid {
      border-color: #ff4d4f;
    }
    .error-message {
      color: #ff4d4f;
      font-size: 12px;
      margin-top: 4px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="eco-shell">
    <aside class="eco-illustration">
      <div class="illustration-content">
        <h1>绿行积分</h1>
        <p>加入"晋碳行"，记录低碳出行，随时获取积分并兑换绿色福利。</p>
        <div class="badge-row">
          <span class="badge-soft">出行积分</span>
          <span class="badge-soft">实时审核</span>
          <span class="badge-soft">积分商城</span>
        </div>
        <div class="wave-animation"></div>
      </div>
    </aside>

    <section class="eco-form">
      <div class="form-header">
        <h2>用户登录</h2>
        <p>支持用户、商户、管理员账号，凭证一致即可登录。</p>
      </div>

      <!-- 登录方式切换按钮 -->
      <div class="tab-switch">
        <div class="tab-btn active" onclick="switchTab('pwd')">账号密码登录</div>
        <div class="tab-btn" onclick="switchTab('sms')">手机验证码登录</div>
      </div>

      <!-- ========== 账号密码登录 ========== -->
      <div id="tab_pwd" class="tab-content active">
        <div class="input-group">
          <input id="login_id" class="input" placeholder="账号 / 用户ID">
          <input id="login_password" class="input" placeholder="密码" type="password">
        </div>

        <div class="form-actions">
          <label style="font-weight:600;color:#1d2a41">
            <input id="rememberMe" type="checkbox" style="margin-right:8px;">记住我
          </label>
          <a href="{{ url_for("user.forgot") }}" class="link" style="font-size:14px;">忘记密码？</a>
        </div>

        <button class="btn" onclick="login()">立即登录</button>
      </div>

      <!-- ========== 手机验证码登录 ========== -->
      <div id="tab_sms" class="tab-content">
        <div class="input-group">
          <input id="phone" class="input" placeholder="手机号" maxlength="11">
          <div id="phone-error" class="error-message">请输入正确的手机号</div>
          
          <div style="display:flex;align-items:center;margin-top:12px;">
            <input id="sms_code" class="input" placeholder="短信验证码" style="flex:1;">
            <button id="sendCodeBtn" class="code-btn" onclick="sendCode()">获取验证码</button>
          </div>
          <div id="code-error" class="error-message">请输入验证码</div>
        </div>

        <button class="btn" onclick="loginBySMS()">手机号登录</button>
      </div>

      <p style="text-align:center;margin-top:18px;font-size:14px;color:#5b6375;">
        还没有账号？<a href="{{ url_for("user.register") }}" class="link">立即注册</a>
      </p>
    </section>
  </div>

  <script src="../../static/js/script.js"></script>
  <script>
    initLoginPage();

    // 切换登录方式
    function switchTab(type) {
      document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(area => area.classList.remove("active"));

      if (type === "pwd") {
        document.querySelectorAll(".tab-btn")[0].classList.add("active");
        document.getElementById("tab_pwd").classList.add("active");
      } else {
        document.querySelectorAll(".tab-btn")[1].classList.add("active");
        document.getElementById("tab_sms").classList.add("active");
      }
    }

    // 验证手机号格式
    function validatePhone(phone) {
      const regex = /^1[3-9]\d{9}$/;
      return regex.test(phone);
    }

    // 验证码倒计时
    function startCountdown(seconds = 60) {
      const btn = document.getElementById('sendCodeBtn');
      btn.disabled = true;
      btn.classList.add('disabled');
      let remaining = seconds;
      btn.textContent = `${remaining}秒后重试`;
      
      const timer = setInterval(() => {
        remaining--;
        btn.textContent = `${remaining}秒后重试`;
        
        if (remaining <= 0) {
          clearInterval(timer);
          btn.disabled = false;
          btn.classList.remove('disabled');
          btn.textContent = '获取验证码';
        }
      }, 1000);
    }

    // 发送验证码
    async function sendCode() {
      const phone = document.getElementById("phone").value;
      const phoneError = document.getElementById("phone-error");
      
      // 验证手机号
      if (!validatePhone(phone)) {
        document.getElementById("phone").classList.add("invalid");
        phoneError.style.display = "block";
        return;
      }
      
      // 清除错误状态
      document.getElementById("phone").classList.remove("invalid");
      phoneError.style.display = "none";
      
      try {
        // ******** API 地址 ********
        const res = await apiFetch("/api/sms/send-code", { 
          method: "POST", 
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ 
            phone: phone,
            type: "login"  // 指定验证码类型为登录
          })
        });

        if (res.code === 200) {
          // 开始60秒倒计时
          startCountdown();
          
          // 提示用户（实际项目中可用更优雅的方式）
          console.log("验证码已发送，请注意查收");
        } else {
          alert(res.msg || "验证码发送失败，请稍后重试");
        }
      } catch (error) {
        console.error("发送验证码出错:", error);
        alert("网络错误，请检查连接后重试");
      }
    }

    // 手机号登录
    async function loginBySMS() {
      const phone = document.getElementById("phone").value;
      const code = document.getElementById("sms_code").value;
      const phoneError = document.getElementById("phone-error");
      const codeError = document.getElementById("code-error");
      
      // 验证输入
      let isValid = true;
      
      if (!validatePhone(phone)) {
        document.getElementById("phone").classList.add("invalid");
        phoneError.style.display = "block";
        isValid = false;
      } else {
        document.getElementById("phone").classList.remove("invalid");
        phoneError.style.display = "none";
      }
      
      if (!code) {
        document.getElementById("sms_code").classList.add("invalid");
        codeError.style.display = "block";
        isValid = false;
      } else {
        document.getElementById("sms_code").classList.remove("invalid");
        codeError.style.display = "none";
      }
      
      if (!isValid) return;
      
      try {
        // ******** API 地址 ********
        const res = await apiFetch("/api/user/login-by-sms", { 
          method: "POST",
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ 
            phone: phone,
            code: code
          })
        });

        if (res.code === 200) {
          // 登录成功处理
          localStorage.setItem("token", res.data.token);
          localStorage.setItem("userInfo", JSON.stringify(res.data.userInfo));
          
          // 跳转到首页或来源页面
          window.location.href = "/home";
        } else {
          alert(res.msg || "登录失败，请检查验证码");
        }
      } catch (error) {
        console.error("登录出错:", error);
        alert("网络错误，请检查连接后重试");
      }
    }

    // 初始化手机号输入监听
    document.getElementById("phone")?.addEventListener("input", function() {
      if (this.classList.contains("invalid")) {
        this.classList.remove("invalid");
        document.getElementById("phone-error").style.display = "none";
      }
    });
    
    // 初始化验证码输入监听
    document.getElementById("sms_code")?.addEventListener("input", function() {
      if (this.classList.contains("invalid")) {
        this.classList.remove("invalid");
        document.getElementById("code-error").style.display = "none";
      }
    });
  </script>
</body>
</html>
