# 阿里云短信服务配置说明

## 1. 开通阿里云短信服务

1. 登录 [阿里云控制台](https://www.aliyun.com/)
2. 搜索并进入"短信服务"
3. 点击"立即开通"（如果未开通）
4. 同意服务协议并开通服务

## 2. 创建RAM子账号（推荐）

为了安全起见，建议创建专门的RAM子账号用于短信服务：

1. 进入 [RAM控制台](https://ram.console.aliyun.com/)
2. 创建新用户
3. 为用户添加权限策略：`AliyunDysmsFullAccess`（短信服务完整权限）
4. 创建AccessKey，并记录下 `AccessKey ID` 和 `AccessKey Secret`

## 3. 申请短信签名

1. 进入 [短信服务控制台](https://dysms.console.aliyun.com/)
2. 点击"国内消息" → "签名管理"
3. 点击"添加签名"
4. 填写签名信息：
   - **签名名称**：例如"绿行积分"（注意：签名必须与实际应用名称一致）
   - **适用场景**：选择"验证码"
   - **签名来源**：选择已备案的网站或小程序
   - **证明材料**：上传相关资质文件
5. 提交审核（通常需要1-2小时审核时间）

## 4. 申请短信模板

1. 在短信服务控制台，点击"国内消息" → "模板管理"
2. 点击"添加模板"
3. 填写模板信息：
   - **模板类型**：验证码
   - **模板名称**：例如"绿行积分验证码"
   - **模板内容**：`您的验证码是${code}，5分钟内有效。`
   - **适用场景**：登录验证
4. 提交审核（通常需要1-2小时审核时间）

## 5. 配置项目

打开 `utils/sms_config.py` 文件，修改以下配置：

```python
# 阿里云AccessKey
ACCESS_KEY_ID = "your_actual_access_key_id"  # 替换为实际的AccessKey ID
ACCESS_KEY_SECRET = "your_actual_access_key_secret"  # 替换为实际的AccessKey Secret

# 短信签名名称（确保与审核通过的签名一致）
SIGN_NAME = "绿行积分"  # 替换为您的实际签名名称

# 短信模板代码（替换为审核通过的实际模板代码）
TEMPLATE_CODE = "SMS_xxxxxxx"  # 替换为您的实际模板代码
```

## 6. 测试发送

配置完成后，可以测试短信发送：

1. 重启Flask应用
2. 尝试使用手机号获取验证码
3. 查看控制台输出，确认是否发送成功

## 7. 注意事项

1. **测试阶段**：可以在短信服务控制台设置"白名单"，只对指定的测试手机号发送短信
2. **费用说明**：短信服务按条计费，国内短信约0.045元/条
3. **发送限制**：
   - 同一个手机号1分钟内只能发送1次
   - 同一个手机号1小时内只能发送5次
   - 同一个手机号1天内只能发送10次
4. **错误处理**：系统会自动处理常见的发送错误，如频率限制、余额不足等

## 8. 常见错误码

- `isv.BUSINESS_LIMIT_CONTROL`：发送频率超限
- `isv.DAY_LIMIT_CONTROL`：日发送次数超限
- `isv.MOBILE_NUMBER_ILLEGAL`：手机号格式错误
- `isv.AMOUNT_NOT_ENOUGH`：账户余额不足
- `isv.SMS_TEMPLATE_ILLEGAL`：短信模板未审核通过
- `isv.SMS_SIGN_ILLEGAL`：短信签名未审核通过

## 9. 监控和日志

系统会自动记录所有短信发送日志，包括：
- 发送时间
- 手机号
- 验证码
- 发送结果
- 错误信息

日志会输出到Flask应用的控制台，便于调试和问题排查。

## 10. 生产环境部署建议

1. **环境变量配置**：建议将AccessKey等敏感信息存储在环境变量中
2. **日志记录**：建议将短信发送日志记录到文件
3. **监控告警**：设置短信发送失败的监控告警
4. **充值提醒**：设置账户余额提醒，避免欠费影响服务

## 开发环境

如果暂时没有配置阿里云短信服务，系统会自动运行在开发环境模式下：
- 验证码只会打印在控制台
- 前端会显示测试验证码
- 不会发送真实短信