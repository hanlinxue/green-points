<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <title>提现功能测试</title>
</head>
<body>
  <h1>提现功能测试</h1>
  <p>请先登录商户账号，然后测试提现功能</p>

  <div>
    <h2>商户登录</h2>
    <input type="text" id="merchantId" placeholder="商户账号 (Mtest_merchant)" value="Mtest_merchant">
    <input type="password" id="merchantPassword" placeholder="密码" value="123456">
    <button onclick="login()">登录</button>
  </div>

  <div style="margin-top: 20px;">
    <h2>当前积分</h2>
    <div id="pointsInfo">请先登录</div>
  </div>

  <div style="margin-top: 20px;">
    <h2>测试提现</h2>
    <input type="number" id="withdrawAmount" placeholder="提现积分" value="100" min="100">
    <button onclick="testWithdrawal()">申请提现</button>
  </div>

  <div style="margin-top: 20px;">
    <h2>提现记录</h2>
    <div id="withdrawalRecords"></div>
  </div>

  <div style="margin-top: 20px;">
    <h2>日志输出</h2>
    <div id="log" style="border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; white-space: pre-wrap; font-family: monospace;"></div>
  </div>

  <script>
    function log(message) {
      const logDiv = document.getElementById('log');
      logDiv.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
    }

    async function login() {
      const id = document.getElementById('merchantId').value;
      const password = document.getElementById('merchantPassword').value;

      try {
        const response = await fetch('/user/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ id, password })
        });

        const data = await response.json();

        if (response.ok) {
          log('登录成功: ' + data.message);
          await fetchPoints();
          await fetchRecords();
        } else {
          log('登录失败: ' + data.message);
        }
      } catch (error) {
        log('登录错误: ' + error.message);
      }
    }

    async function fetchPoints() {
      try {
        const response = await fetch('/merchant/api/get-merchant-points');
        const data = await response.json();

        if (response.ok) {
          const pointsInfo = document.getElementById('pointsInfo');
          pointsInfo.innerHTML = `
            <p>当前积分: ${data.points}</p>
            <p>兑换汇率: 1积分 = ${data.exchangeRate}元</p>
            <p>可兑换金额: ${data.points * data.exchangeRate}元</p>
          `;
          log('获取积分信息成功');
        } else {
          log('获取积分失败: ' + data.error);
        }
      } catch (error) {
        log('获取积分错误: ' + error.message);
      }
    }

    async function testWithdrawal() {
      const amount = document.getElementById('withdrawAmount').value;

      if (!amount || amount < 100) {
        log('提现金额必须大于等于100');
        return;
      }

      try {
        const response = await fetch('/merchant/api/process-withdrawal', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ withdrawAmount: parseInt(amount) })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          log('提现申请成功!');
          log('提现单号: ' + data.withdrawal_no);
          log('提现金额: ' + data.cash_amount + '元');
          document.getElementById('withdrawAmount').value = '';
          await fetchPoints();
          await fetchRecords();
        } else {
          log('提现失败: ' + (data.error || data.message || '未知错误'));
        }
      } catch (error) {
        log('提现错误: ' + error.message);
      }
    }

    async function fetchRecords() {
      try {
        const response = await fetch('/merchant/api/withdrawal-records');
        const data = await response.json();

        if (response.ok && data.success) {
          const recordsDiv = document.getElementById('withdrawalRecords');
          if (data.records.length === 0) {
            recordsDiv.innerHTML = '<p>暂无提现记录</p>';
          } else {
            const recordsHtml = data.records.map(record => {
              const statusText = ['待审核', '审核通过', '审核拒绝', '提现完成', '提现失败'][record.status] || '未知';
              return `
                <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0;">
                  <p>提现单号: ${record.withdrawal_no}</p>
                  <p>提现积分: ${record.points_amount}</p>
                  <p>提现金额: ${record.cash_amount}元</p>
                  <p>状态: ${statusText}</p>
                  <p>申请时间: ${new Date(record.create_time).toLocaleString()}</p>
                </div>
              `;
            }).join('');

            recordsDiv.innerHTML = recordsHtml;
          }
          log('获取提现记录成功');
        } else {
          log('获取提现记录失败: ' + data.error);
        }
      } catch (error) {
        log('获取提现记录错误: ' + error.message);
      }
    }

    // 页面加载时自动检查登录状态
    window.onload = function() {
      log('页面加载完成，开始测试...');
    };
  </script>
</body>
</html>